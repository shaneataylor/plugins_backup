<?xml version="1.0" encoding="UTF-8"?>
<!-- Extend the toolkit's XHTML processing to generate WebHelp output. -->
<project name="net.webassign.webhelp.integrator" default="dita2h5help" basedir=".">
    
    <!-- set default values for plugin build params -->
    <property name="h5help.name" value=""/>
    <property name="h5help.google.cse.id" value=""/><!-- non-empty tries to render search -->
    <property name="h5help.google.cse.refinement" value=""/>
    <property name="h5help.feedback" value="no"/><!-- add feedback feature (yes or no) -->
    
    <target name="dita2h5help"
        depends="build-init, preprocess, copy-h5help-resources, dita.map.xhtml,
        copy-css, dita.topics.xhtml, dita.inner.topics.xhtml, dita.outer.topics.xhtml, gen-sitemap"/>

    <target name="copy-h5help-resources">
        <copy todir="${output.dir}">
            <fileset
                dir="${dita.dir}${file.separator}plugins${file.separator}net.webassign.webhelp${file.separator}resources"
                includes="**${file.separator}*"/>
        </copy>
        <copy file="${source.dir}${file.separator}h5csh.json" todir="${output.dir}" verbose="true"/>
        <echo level="info">Creating ${output.dir}${file.separator}h5help${file.separator}h5params.json</echo>
        
        <!-- make h5params.json -->
        <echo append="no" file="${output.dir}${file.separator}h5help${file.separator}h5params.json" force="yes">{
"toc_file"                  : "${args.xhtml.toc}${args.outext}",
"help_name"                 : "${h5help.name}",
"google_cse_id"             : "${h5help.google.cse.id}",
"google_cse_refinement"     : "${h5help.google.cse.refinement}",
"feedback"                  : "${h5help.feedback}"
        }</echo>
    </target>
    
    <target name="gen-sitemap">
        <!-- note: assumes a flat output file structure -->
        <fileset id="output.files" dir="${output.dir}" includes="*${args.outext}">
            <exclude name="${args.xhtml.toc}${args.outext}"/>
        </fileset>
        <property name="output.files.list" refid="output.files"/>
        <echo file="${output.dir}${file.separator}sitemap.temp">${output.dir}</echo>
        <replaceregexp byline="true" flags="g" file="${output.dir}${file.separator}sitemap.temp">
            <regexp pattern="^.*[\/]([^\/]+)$"/>
            <substitution expression="\1" />
        </replaceregexp>
        <loadfile property="urlpath" srcfile="${output.dir}${file.separator}sitemap.temp"/>
        <property name="baseurl">http://www.webassign.net/manual/${urlpath}/</property>
        <tstamp>
            <format property="lastmod" pattern="yyyy-MM-dd"/>
        </tstamp>
        <property name="replaceexpr"><![CDATA[
<url><loc>${baseurl}\1<\/loc><lastmod>${lastmod}<\/lastmod><changefreq>monthly<\/changefreq><\/url>]]></property>
        
        <echo file="${output.dir}${file.separator}sitemap.temp">${output.files.list}</echo>
        <replaceregexp byline="true" flags="g" file="${output.dir}${file.separator}sitemap.temp">
            <regexp pattern="([^;]*);?"/>
            <substitution expression="${replaceexpr}" />
        </replaceregexp>
        <concat destfile="${output.dir}${file.separator}sitemap.xml" >
            <header><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<urlset
    xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.sitemaps.org/schemas/sitemap/0.9
    http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd">
    ]]></header>
            <fileset file="${output.dir}${file.separator}sitemap.temp"/>
            <footer><![CDATA[
                </urlset>]]></footer>
        </concat>
        <delete file="${output.dir}${file.separator}sitemap.temp"/>
    </target>


    <!-- Customize header and footer of each topic. -->
    <!--<target name="dita.inner.topics.webassign.webhelp" description="Build WebHelp output from dita topics">
    <property name="out.ext" value=".html"/>
    <property name="transtype.ext" value=".xsl"/>
    <property name="args.xsl"
      value="${dita.dir}${file.separator}plugins${file.separator}net.webassign.webhelp${file.separator}xsl${file.separator}dita2webhelp.xsl"/>
    <makeurl file="${dita.input.valfile}" property="dita.input.valfile.url" validate="no"></makeurl>
    
    <xslt processor="trax" 
      basedir="${dita.temp.dir}" 
      destdir="${output.dir}" 
      includesfile="${dita.temp.dir}${file.separator}${fullditatopicfile}" 
      classpathref="dost.class.path" 
      extension="${out.ext}" 
      style="${args.xsl}" 
      filenameparameter="filename" 
      filedirparameter="filedir">
      <excludesfile name="${dita.temp.dir}${file.separator}${resourceonlyfile}" if="resourceonlyfile"></excludesfile>
      <includesfile name="${dita.temp.dir}${file.separator}${chunkedtopicfile}" if="chunkedtopicfile"></includesfile>
      <param name="TRANSTYPE" expression="${transtype}"></param>
      <param name="DITAEXT" expression="${dita.ext}" if="dita.ext"></param>
      <param name="FILTERFILE" expression="${dita.input.valfile.url}" if="dita.input.valfile"></param>
      <param name="CSS" expression="${args.css.file}" if="args.css.file"></param>
      <param name="CSSPATH" expression="${user.csspath}" if="user.csspath"></param>
      <param name="HDF" expression="${args.hdf}" if="args.hdf"></param>
      <param name="HDR" expression="${args.hdr}" if="args.hdr"></param>
      <param name="FTR" expression="${args.ftr}" if="args.ftr"></param>
      <param name="DRAFT" expression="${args.draft}" if="args.draft"></param>
      <param name="ARTLBL" expression="${args.artlbl}" if="args.artlbl"></param>
      <param name="GENERATE-TASK-LABELS" expression="${args.gen.task.lbl}" if="args.gen.task.lbl"></param>
      <param name="PRESERVE-DITA-CLASS" expression="${args.xhtml.classattr}" if="args.xhtml.classattr"></param>
      <param name="NOPARENTLINK" expression="${args.hide.parent.link}" if="args.hide.parent.link"></param>
      <param name="BREADCRUMBS" expression="${args.breadcrumbs}" if="args.breadcrumbs"></param>
      <param name="INDEXSHOW" expression="${args.indexshow}" if="args.indexshow"></param>
      <param name="genDefMeta" expression="${args.gen.default.meta}" if="args.gen.default.meta"></param>
      <param name="OUTEXT" expression="${out.ext}" if="out.ext"></param>
      <param name="BASEDIR" expression="${basedir}"></param>
      <param name="OUTPUTDIR" expression="${output.dir}"></param>
      <param name="DBG" expression="${args.debug}" if="args.debug"></param>
      <param name="CUSTOM_WEBHELP_SEARCH" expression="${custom.webhelp.search}"/>
      <param name="CUSTOM_BASEDIR" expression="${dita.temp.dir}"/>
      <mapper type="regexp" from="^(${tempdirToinputmapdir.relative.value})(.*?)(\.(xml|dita))$$" to="\2${out.ext}"></mapper>
    </xslt>
  </target>-->


    <!-- Customize table of contents. -->
    <!--<target name="dita.out.map.webassign.webhelp.toc" depends="webassign.detectIndexerLang" description="Build WebHelp TOC file">
    <xslt processor="trax"
      basedir="${dita.temp.dir}"
      destdir="${output.dir}"
      includesfile="${dita.temp.dir}${file.separator}${user.input.file.listfile}"
      classpathref="dost.class.path"
      style="${dita.dir}${file.separator}plugins${file.separator}net.webassign.webhelp${file.separator}xsl${file.separator}map2xhtmtoc.xsl">
      <excludesfile name="${dita.temp.dir}${file.separator}${resourceonlyfile}" if="resourceonlyfile"/>
      <param name="DITAEXT" expression="${dita.ext}" if="dita.ext" />
      <param name="OUTEXT" expression="${out.ext}" if="out.ext" />
      <param name="contenttarget" expression="${args.xhtml.contenttarget}" if="args.xhtml.contenttarget"/>
      <param name="CSS" expression="${args.css.file}" if="args.css.file" />
      <param name="CSSPATH" expression="${user.csspath}" if="user.csspath" />
      <param name="OUTPUTCLASS" expression="${args.xhtml.toc.class}" if="args.xhtml.toc.class" />
      <param name="CUSTOM_WEBHELP_SEARCH" expression="${custom.webhelp.search}" if="custom.webhelp.search"/>
      <param name="CUSTOM_PHP_SEARCH_TARGET" expression="${custom.php.search.target}" if="custom.php.search.target"/>
      <param name="WEBHELP_COPYRIGHT" expression="${webhelp.copyright}" if="webhelp.copyright"/>
      <param name="INDEXER_LANGUAGE" expression="${indexer.lang}" if="indexer.lang"/>
      <mapper type="glob" from="${user.input.file}" to="${args.xhtml.toc}${out.ext}" />
    </xslt>
  </target>-->


</project>
