<?xml version="1.0" encoding="UTF-8"?>
<!-- Extend the toolkit's XHTML processing to generate WebHelp output. -->
<project name="net.webassign.webhelp.integrator" default="dita2h5help" basedir=".">
    
    <!-- set default values for plugin build params -->
    <property name="h5help.name" value=""/>
    <property name="h5help.google.cse.id" value=""/><!-- non-empty tries to render search -->
    <property name="h5help.google.cse.refinement" value=""/>
    <property name="h5help.feedback" value="no"/><!-- add feedback feature (yes or no) -->
    <property name="h5help.prettify.code" value="no"/><!-- prettify code examples (yes or no) -->
    <property name="h5help.disqus.shortname" value=""/>
    <property name="h5help.conreftarget.rule" value=""/>
    <property name="h5help.copy.cssroot" value="no"/>
    
    
    
    <target name="dita2h5help"
        depends="build-init, preprocess, dita.map.xhtml,
        copy-css, dita.topics.xhtml, dita.inner.topics.xhtml, 
        dita.outer.topics.xhtml, xhtml2h5help, gen-sitemap, copy-h5help-resources"/>
    
    
    <target name="h5help.check.conrefs" description="Ensure conref targets adhere to rule specified by h5help.conreftarget.rule">
        <!--<property name="conref_file_list" value="${dita.temp.dir}${file.separator}conref.list" />
        <echo message="Conref list = ${conref_file_list}"></echo>-->
        <xslt basedir="${dita.temp.dir}"
            includesfile="${dita.temp.dir}${file.separator}conref.list" 
            destdir="${dita.temp.dir}"
            style="${dita.dir}${file.separator}plugins${file.separator}net.webassign.webhelp${file.separator}xsl${file.separator}conref_rule_checking.xsl"
            filenameparameter="thisconreffer"
            failOnError="false">
            <param name="h5help.conreftarget.rule" expression="${h5help.conreftarget.rule}"></param>
        </xslt>
    </target>

    <target name="copy-h5help-resources">
        <copy todir="${output.dir}" failonerror="false">
            <fileset
                dir="${dita.dir}${file.separator}plugins${file.separator}net.webassign.webhelp${file.separator}resources"
                includes="**${file.separator}*"/>
        </copy>
        <copy file="${args.input.dir}${file.separator}h5csh.json" todir="${output.dir}" verbose="true" failonerror="false"/>
        <copy file="${output.dir}${file.separator}index.htm" tofile="${output.dir}${file.separator}index.html" verbose="true" failonerror="false"/>
        <echo level="info">Creating ${output.dir}${file.separator}h5help${file.separator}h5params.json</echo>
        
        <!-- make h5params.json -->
        <echo append="no" file="${output.dir}${file.separator}h5help${file.separator}h5params.json" force="yes">{
"toc_file"                  : "${args.xhtml.toc}${args.outext}",
"help_name"                 : "${h5help.name}",
"google_cse_id"             : "${h5help.google.cse.id}",
"google_cse_refinement"     : "${h5help.google.cse.refinement}",
"disqus_shortname"          : "${h5help.disqus.shortname}",
"feedback"                  : "${h5help.feedback}",
"prettify_code"             : "${h5help.prettify.code}"
}</echo>
        
        <antcall target="copy-cssroot"/>
        
    </target>
    
    <target name="copy-cssroot" depends="check-copy-cssroot" if="copy_cssroot">
        <copy todir="${output.dir}${file.separator}${args.csspath}" failonerror="false">
            <fileset dir="${args.cssroot}" includes="**${file.separator}*"/>
        </copy>
    </target>
    
    <target name="check-copy-cssroot">
        <condition property="copy_cssroot">
            <and>
                <istrue value="${h5help.copy.cssroot}"/>
                <isset property="args.cssroot"/>
                <isset property="args.csspath"/>
            </and>
        </condition>
    </target>
    
    <target name="gen-sitemap">
        <!-- note: assumes a flat output file structure -->
        <fileset id="output.files" dir="${output.dir}" includes="*${args.outext}">
            <exclude name="${args.xhtml.toc}${args.outext}"/>
        </fileset>
        <property name="output.files.list" refid="output.files"/>
        <echo file="${output.dir}${file.separator}sitemap.temp">${output.dir}</echo>
        <replaceregexp byline="true" flags="g" file="${output.dir}${file.separator}sitemap.temp">
            <regexp pattern="^.*[\/]([^\/]+)$"/>
            <substitution expression="\1" />
        </replaceregexp>
        <loadfile property="urlpath" srcfile="${output.dir}${file.separator}sitemap.temp"/>
        <property name="baseurl">http://www.webassign.net/manual/${urlpath}/</property>
        <tstamp>
            <format property="lastmod" pattern="yyyy-MM-dd"/>
        </tstamp>
        <property name="replaceexpr"><![CDATA[
<url><loc>${baseurl}\1<\/loc><lastmod>${lastmod}<\/lastmod><changefreq>monthly<\/changefreq><\/url>]]></property>
        
        <echo file="${output.dir}${file.separator}sitemap.temp">${output.files.list}</echo>
        <replaceregexp byline="true" flags="g" file="${output.dir}${file.separator}sitemap.temp">
            <regexp pattern="([^;]*);?"/>
            <substitution expression="${replaceexpr}" />
        </replaceregexp>
        <concat destfile="${output.dir}${file.separator}sitemap.xml" >
            <header><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<urlset
    xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.sitemaps.org/schemas/sitemap/0.9
    http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd">
    ]]></header>
            <fileset file="${output.dir}${file.separator}sitemap.temp"/>
            <footer><![CDATA[
                </urlset>]]></footer>
        </concat>
        <delete file="${output.dir}${file.separator}sitemap.temp"/>
    </target>

    <target name="xhtml2h5help">
        <!-- First, move output files -->
        <move todir="${output.dir}${file.separator}temp_xhtml" includeemptydirs="false">
            <fileset dir="${output.dir}">
                <include name="*${args.outext}"/>
                <exclude name="${args.xhtml.toc}${args.outext}"/>
            </fileset>
        </move>
        <!-- Process files to HTML5 help framework -->
        <xslt basedir="${output.dir}${file.separator}temp_xhtml" includes="*${args.outext}" 
            destdir="${output.dir}" extension="${args.outext}"
            style="${dita.dir}${file.separator}plugins${file.separator}net.webassign.webhelp${file.separator}xsl${file.separator}xhtml2h5help.xsl"
            failOnError="true">
            <param name="h5help.feedback" expression="${h5help.feedback}"/>
        </xslt>
        <!-- Clean up temp directory -->
        <delete dir="${output.dir}${file.separator}temp_xhtml"></delete>
    </target>



</project>
